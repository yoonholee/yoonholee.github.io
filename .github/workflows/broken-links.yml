name: Check for broken links

on:
  workflow_run:
    workflows: [deploy]
    types: [completed]

jobs:
  check-links:
    # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-a-workflow-based-on-the-conclusion-of-another-workflow
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # available images: https://github.com/actions/runner-images#available-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'
          bundler-cache: true
      - name: Update _config.yml âš™ï¸
        run: |
          echo "" >> _config.yml
          echo "github_repo: \"$GITHUB_REPOSITORY\"" >> _config.yml
          echo "baseurl: \"\"" >> _config.yml
      - name: Install and Build ðŸ”§
        run: |
          pip3 install --upgrade jupyter
          npm install -g mermaid.cli
          npm install -g purgecss
          bundle install
          bundle exec jekyll build --verbose
          purgecss -c purgecss.config.js
      - name: Check links with Lychee ðŸ”—
        uses: lycheeverse/lychee-action@v2
        with:
          args: --offline --verbose --no-progress '_site/**/*.html' --remap "https://yoonholee.com/ _site/" --remap "https://www.yoonholee.com/ _site/"
          fail: true
