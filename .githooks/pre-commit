#!/bin/bash
# Pre-commit hook: verify site builds and lints pass before committing

set -e

echo "Running pre-commit checks..."

# Check if any SCSS/JS files are staged
STAGED_SCSS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.scss$' || true)
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.js$' || true)

# Run Jekyll build (catches Liquid errors and SCSS compilation)
echo "→ Building site..."
if ! bundle exec jekyll build --quiet 2>&1; then
    echo "✗ Jekyll build failed. Fix errors before committing."
    exit 1
fi
echo "✓ Jekyll build passed"

# Run CSS linter if SCSS files changed
if [ -n "$STAGED_SCSS" ]; then
    echo "→ Linting SCSS..."
    if ! npm run lint:css --silent 2>&1; then
        echo "✗ SCSS lint failed. Run 'npm run lint:css -- --fix' to auto-fix."
        exit 1
    fi
    echo "✓ SCSS lint passed"
fi

# Run JS linter if JS files changed
if [ -n "$STAGED_JS" ]; then
    echo "→ Linting JavaScript..."
    if ! npm run lint:js --silent 2>&1; then
        echo "✗ JavaScript lint failed. Run 'npm run lint:js -- --fix' to auto-fix."
        exit 1
    fi
    echo "✓ JavaScript lint passed"
fi

echo "All pre-commit checks passed!"
